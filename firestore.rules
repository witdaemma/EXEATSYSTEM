rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to make rules readable
    function isStaff() {
      // Check if the requesting user has a staff role in their user profile.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['porter', 'hod', 'dsa'];
    }
    
    function isOwner(exeat) {
      // Check if the requesting user is the student who owns the exeat.
      return request.auth.uid == exeat.studentId;
    }

    // Rules for user profiles
    match /users/{userId} {
      // Users can read and update their own profile.
      allow read, update: if request.auth.uid == userId;
      // Any authenticated user can create a profile (for student signup).
      allow create: if request.auth != null;
    }

    // Rules for counters used for ID generation
    match /counters/{counterId} {
      // Any logged-in user can read/write to the counter.
      allow read, write: if request.auth != null;
    }

    // Rules for exeat requests collection
    match /exeatRequests/{exeatId} {
      
      // WHO CAN READ documents (get and list)?
      // A user can read a document if they are the owner OR if they are staff.
      // This rule correctly allows the dashboard queries for both students and staff.
      allow read: if isOwner(resource.data) || isStaff();
      
      // WHO CAN CREATE documents?
      // Only a student creating a request for themselves.
      allow create: if isOwner(request.resource.data);

      // WHO CAN UPDATE documents?
      // Only staff members.
      allow update: if isStaff();
      
      // Rules for the approval trail subcollection
      match /approvalTrail/{trailId} {
        // Staff can create comments/actions. Students create the initial one.
        allow create: if request.auth != null;
        // Anyone who can read the exeat can also read its trail.
        allow read: if request.auth != null;
      }
    }
  }
}
